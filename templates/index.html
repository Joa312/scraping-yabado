<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scraping.YABADO.se - M√§klarprofil Scraping Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .upload-section {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px;
            border: 3px dashed #3498db;
            border-radius: 15px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .upload-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .file-input {
            margin: 20px 0;
        }

        .file-input input[type="file"] {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: bold;
        }

        .file-label:hover {
            transform: translateY(-2px);
        }

        .process-btn {
            padding: 15px 40px;
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }

        .process-btn:hover {
            transform: translateY(-2px);
        }

        .process-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .download-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 10px;
        }

        .csv-format {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }

        .csv-format h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .csv-format code {
            background: #ecf0f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        .progress-section {
            margin-top: 30px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .results-section {
            margin-top: 30px;
            display: none;
        }

        .agent-result {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }

        .agent-result.success {
            border-left-color: #27ae60;
        }

        .agent-result.failed {
            border-left-color: #e74c3c;
        }

        .agent-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .download-section {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: #e8f5e8;
            border-radius: 10px;
        }

        .log-section {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .footer {
            text-align: center;
            color: white;
            opacity: 0.8;
            margin-top: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Scraping.YABADO.se</h1>
            <p>Riktig m√§klarprofil scraping fr√•n hittamaklare.se</p>
        </div>

        <div class="main-card">
            <div class="upload-section">
                <h2>üìÅ Ladda upp CSV-fil med m√§klare</h2>
                <p>Verktyget h√§mtar verklig statistik och data fr√•n hittamaklare.se</p>
                
                <div class="file-input">
                    <label for="csvFile" class="file-label">
                        üìÑ V√§lj CSV-fil
                    </label>
                    <input type="file" id="csvFile" accept=".csv">
                </div>
                
                <div id="fileName" style="margin: 10px 0; color: #666;"></div>
                
                <!-- AI-aktivering -->
                <div style="margin: 20px 0; padding: 20px; background: #e8f6e8; border-radius: 10px; border: 2px solid #27ae60;">
                    <label style="display: inline-flex; align-items: center; color: #2c3e50; font-size: 1.1rem;">
                        <input type="checkbox" id="useAiProcessing" style="margin-right: 12px; transform: scale(1.2);">
                        <strong>ü§ñ Aktivera AI-bearbetning f√∂r unika m√§klarprofiler</strong>
                    </label>
                    <p style="color: #27ae60; font-size: 0.95rem; margin-top: 8px; font-weight: 500;">
                        üìã Skapar professionella, unika beskrivningar f√∂r varje m√§klare baserat p√• deras prestationer och erfarenhet.
                    </p>
                </div>
                
                <button id="processBtn" class="process-btn" disabled>
                    üöÄ Starta scraping
                </button>
            </div>

            <div class="csv-format">
                <h3>üìã CSV-filformat</h3>
                <p><strong>Bjurfors-format:</strong></p>
                <code>Allings√•s,<br>
                0764-92 55 55,carina.berg@bjurfors.se<br>
                0733-73 74 81,jennie.ajo@bjurfors.se</code>
                
                <p style="margin-top: 15px;"><strong>Standard-format:</strong></p>
                <code>email,phone,city<br>
                anna@company.se,070-123456,Stockholm</code>
            </div>

            <div id="progressSection" class="progress-section">
                <div class="progress-text">Scraper m√§klarprofiler...</div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div id="progressDetails">0 av 0 m√§klare bearbetade</div>
            </div>

            <div id="resultsSection" class="results-section">
                <h3>üìä Scraping-resultat</h3>
                <div id="resultsSummary" style="margin: 20px 0; padding: 15px; background: #e8f5e8; border-radius: 8px;"></div>
                <div id="resultsContainer"></div>
                
                <div id="downloadSection" class="download-section" style="display: none;">
                    <h4>üíæ Exportera resultat</h4>
                    <button onclick="showCSVOnPage()" class="download-btn">üìÑ Visa CSV data</button>
                </div>
                
                <div id="csvDisplay" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h4>üìÑ CSV Data - Kopiera nedanst√•ende text</h4>
                    <p><strong>Instruktioner:</strong> Markera all text nedan (klicka 3 g√•nger), kopiera (Ctrl+C), klistra in i Excel/Google Sheets</p>
                    <textarea id="csvTextArea" style="width: 100%; height: 300px; font-family: monospace; font-size: 12px;" readonly onclick="this.select()"></textarea>
                    <br><br>
                    <button onclick="copyCSVText()" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px;">üìã Kopiera till urklipp</button>
                </div>
            </div>

            <div id="logSection" class="log-section" style="display: none;">
                <strong>üîç Scraping-logg:</strong><br>
                <div id="logContent"></div>
            </div>
        </div>

        <div class="footer">
            <p>&copy; 2025 Scraping.YABADO.se - Riktig m√§klarprofil scraping</p>
            <p>H√§mtar verklig statistik fr√•n hittamaklare.se</p>
        </div>
    </div>

    <!-- FLYTTAD JAVASCRIPT TILL SLUTET MED S√ÑKRA NULL-CHECKS -->
    <script>
        // V√§nta tills DOM √§r fullt laddad
        document.addEventListener('DOMContentLoaded', function() {
            const CORS_PROXIES = [
                'https://api.allorigins.win/get?url=',
                'https://corsproxy.io/?'
            ];
            
            let csvData = [];
            let scrapingResults = [];
            let useAiProcessing = false;

            // S√§kra event listeners med null-checks
            const csvFile = document.getElementById('csvFile');
            const processBtn = document.getElementById('processBtn');

            if (csvFile) {
                csvFile.addEventListener('change', handleFileSelect);
            }
            if (processBtn) {
                processBtn.addEventListener('click', processCsv);
            }

            function handleFileSelect(event) {
                const file = event.target.files[0];
                const fileName = document.getElementById('fileName');
                const processBtn = document.getElementById('processBtn');
                
                if (file && fileName && processBtn) {
                    fileName.textContent = 'Vald fil: ' + file.name;
                    fileName.style.color = '#27ae60';
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const csv = e.target.result;
                            csvData = parseCSV(csv);
                            
                            if (csvData.length > 0) {
                                processBtn.disabled = false;
                                fileName.textContent += ' (' + csvData.length + ' m√§klare hittade)';
                            } else {
                                fileName.textContent += ' (Inga giltiga rader hittade)';
                                fileName.style.color = '#e74c3c';
                            }
                        } catch (error) {
                            fileName.textContent = 'Fel vid l√§sning av CSV-fil';
                            fileName.style.color = '#e74c3c';
                        }
                    };
                    reader.readAsText(file);
                } else {
                    if (fileName) fileName.textContent = '';
                    if (processBtn) processBtn.disabled = true;
                }
            }

            function parseCSV(csv) {
                const lines = csv.split('\n').map(line => line.trim()).filter(line => line);
                if (lines.length < 2) return [];
                
                const firstLine = lines[0];
                const secondLine = lines[1];
                
                const secondLineParts = secondLine.split(',');
                if (secondLineParts.length >= 2 && 
                    secondLineParts[1].includes('@') && 
                    secondLineParts[0].match(/^\d/)) {
                    
                    return parseBjurforsFormat(lines);
                }
                
                const headers = firstLine.split(',').map(h => h.trim().toLowerCase());
                const emailIndex = headers.indexOf('email');
                
                if (emailIndex !== -1) {
                    return parseStandardFormat(lines);
                }
                
                return [];
            }

            function parseBjurforsFormat(lines) {
                const city = lines[0].split(',')[0].trim();
                const data = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    if (values.length >= 2) {
                        const phone = values[0];
                        const email = values[1];
                        
                        if (email.includes('@')) {
                            data.push({
                                email: email,
                                phone: phone,
                                city: city
                            });
                        }
                    }
                }
                return data;
            }

            function parseStandardFormat(lines) {
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                const emailIndex = headers.indexOf('email');
                const phoneIndex = headers.indexOf('phone');
                const cityIndex = headers.indexOf('city');
                
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    if (values[emailIndex] && values[emailIndex].includes('@')) {
                        data.push({
                            email: values[emailIndex],
                            phone: phoneIndex !== -1 ? values[phoneIndex] : '',
                            city: cityIndex !== -1 ? values[cityIndex] : ''
                        });
                    }
                }
                return data;
            }

            async function processCsv() {
                if (csvData.length === 0) return;
                
                const useAiProcessingCheckbox = document.getElementById('useAiProcessing');
                useAiProcessing = useAiProcessingCheckbox ? useAiProcessingCheckbox.checked : false;
                
                const progressSection = document.getElementById('progressSection');
                const resultsSection = document.getElementById('resultsSection');
                const logSection = document.getElementById('logSection');
                const processBtn = document.getElementById('processBtn');
                
                if (progressSection) progressSection.style.display = 'block';
                if (resultsSection) resultsSection.style.display = 'block';
                if (logSection) logSection.style.display = 'block';
                
                if (processBtn) {
                    processBtn.disabled = true;
                    processBtn.textContent = 'Scraper...';
                }
                
                scrapingResults = [];
                let processed = 0;
                
                updateProgress(0, csvData.length);
                addLog('üöÄ Startar scraping f√∂r ' + csvData.length + ' m√§klare...');
                
                if (useAiProcessing) {
                    addLog('ü§ñ AI-bearbetning aktiverad f√∂r unika profiler');
                }
                
                for (const agent of csvData) {
                    try {
                        addLog('üîç Scraper profil f√∂r: ' + agent.email);
                        const result = await scrapeAgentProfile(agent);
                        
                        // AI-bearbetning om aktiverat
                        if (useAiProcessing && result.success) {
                            try {
                                addLog('ü§ñ Skapar unik profil f√∂r: ' + result.name);
                                result.ai_processed_text = await createUniqueProfile(result);
                                addLog('‚ú® Unik profil skapad f√∂r ' + result.name);
                            } catch (aiError) {
                                addLog('‚ö†Ô∏è AI-bearbetning misslyckades f√∂r ' + result.name);
                                result.ai_processed_text = null;
                            }
                        }
                        
                        scrapingResults.push(result);
                        displayAgentResult(result);
                        
                        if (result.success) {
                            addLog('‚úÖ H√§mtade data f√∂r ' + result.name);
                        } else {
                            addLog('‚ùå Kunde inte h√§mta data f√∂r ' + agent.email);
                        }
                        
                    } catch (error) {
                        addLog('‚ùå Fel f√∂r ' + agent.email + ': ' + error.message);
                        scrapingResults.push({
                            email: agent.email,
                            phone: agent.phone,
                            city: agent.city,
                            success: false,
                            error: error.message
                        });
                    }
                    
                    processed++;
                    updateProgress(processed, csvData.length);
                    
                    if (processed < csvData.length) {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
                
                showSummary();
                const downloadSection = document.getElementById('downloadSection');
                if (downloadSection) downloadSection.style.display = 'block';
                
                if (processBtn) {
                    processBtn.disabled = false;
                    processBtn.textContent = 'üöÄ Starta scraping';
                }
                
                addLog('‚úÖ Scraping slutf√∂rt!');
            }

            async function scrapeAgentProfile(agent) {
                const emailLocalPart = agent.email.split('@')[0];
                const nameParts = emailLocalPart.split('.');
                
                if (nameParts.length < 2) {
                    throw new Error('Kunde inte extrahera namn fr√•n email');
                }
                
                const profileUrl = 'https://www.hittamaklare.se/' + emailLocalPart;
                
                for (let i = 0; i < CORS_PROXIES.length; i++) {
                    try {
                        const proxy = CORS_PROXIES[i];
                        addLog('üì° F√∂rs√∂ker med proxy ' + (i + 1) + '/' + CORS_PROXIES.length);
                        
                        let response, html;
                        
                        if (proxy.includes('allorigins.win')) {
                            response = await fetch(proxy + encodeURIComponent(profileUrl));
                            const data = await response.json();
                            if (!data.contents) throw new Error('Ingen data fr√•n allorigins');
                            html = data.contents;
                        } else {
                            response = await fetch(proxy + encodeURIComponent(profileUrl));
                            html = await response.text();
                            if (!html || html.length < 100) throw new Error('Tom respons');
                        }
                        
                        return parseProfileData(agent, html, profileUrl);
                        
                    } catch (error) {
                        addLog('‚ùå Proxy ' + (i + 1) + ' misslyckades: ' + error.message);
                        if (i === CORS_PROXIES.length - 1) {
                            return {
                                email: agent.email,
                                phone: agent.phone,
                                city: agent.city,
                                success: false,
                                error: 'Alla proxies misslyckades',
                                profile_url: profileUrl
                            };
                        }
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
            }

            function parseProfileData(agent, html, profileUrl) {
                try {
                    addLog('üîç Parsing HTML-data (' + html.length + ' tecken)');
                    
                    const cleanText = html.replace(/<script[^>]*>.*?<\/script>/gis, '')
                                        .replace(/<style[^>]*>.*?<\/style>/gis, '')
                                        .replace(/<[^>]+>/g, ' ')
                                        .replace(/\s+/g, ' ');
                    
                    let name = extractNameFromEmail(agent.email);
                    
                    const namePatterns = [
                        new RegExp(agent.email.split('@')[0].replace('.', '\\s+'), 'i'),
                        /([A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+\s+[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+)/
                    ];
                    
                    for (const pattern of namePatterns) {
                        const match = html.match(pattern);
                        if (match && match[1] && match[1].trim().length > 3) {
                            name = match[1].trim().replace(/[,\-\|].*/, '').trim();
                            addLog('‚úÖ Hittade namn: "' + name + '"');
                            break;
                        }
                    }
                    
                    const registeredMatch = cleanText.match(/registrerad\s+m√§klare\s+sedan\s+(\d{4}-\d{2}-\d{2})/i);
                    const recommendationsMatch = cleanText.match(/(\d+)\s+rekommendationer?\s+fr√•n\s+s√§ljare/i) || 
                                               cleanText.match(/f√•tt\s+in\s+(\d+)\s+rekommendationer?/i);
                    const salesMatch = cleanText.match(/(\d+)\s+f√∂rs√§ljningar?\s+det\s+senaste\s+halv√•ret/i) ||
                                     cleanText.match(/haft\s+(\d+)\s+f√∂rs√§ljningar?/i);
                    const valueMatch = cleanText.match(/(\d+(?:\s+\d+)*)\s+kr/i);
                    const awardsMatch = cleanText.match(/(\d+)\s+utm√§rkelser?\s+fr√•n\s+hittam√§klare/i);
                    
                    let company = null;
                    const companyPatterns = [
                        /jobbar\s+p√•\s+([^\.]+)/i,
                        /arbetar\s+p√•\s+([^\.]+)/i
                    ];
                    
                    for (const pattern of companyPatterns) {
                        const match = cleanText.match(pattern);
                        if (match && match[1]) {
                            company = match[1].trim().replace(/\s+/g, ' ');
                            break;
                        }
                    }
                    
                    let profileText = null;
                    const sentences = cleanText.split('.').filter(s => 
                        s.length > 80 && 
                        s.length < 400 &&
                        (s.includes('m√§klare') || s.includes(name.split(' ')[0]))
                    );
                    
                    if (sentences.length > 0) {
                        profileText = sentences[0].trim() + '.';
                    }
                    
                    const result = {
                        email: agent.email,
                        phone: agent.phone,
                        city: agent.city,
                        success: true,
                        name: name,
                        company: company || 'Ok√§nt',
                        registered_since: registeredMatch ? registeredMatch[1] : null,
                        recommendations_6m: recommendationsMatch ? parseInt(recommendationsMatch[1]) : null,
                        sales_count_6m: salesMatch ? parseInt(salesMatch[1]) : null,
                        sales_value_6m: valueMatch ? valueMatch[1].replace(/\s/g, '') + ' kr' : null,
                        awards_count: awardsMatch ? parseInt(awardsMatch[1]) : null,
                        profile_text: profileText,
                        profile_url: profileUrl,
                        scraped_at: new Date().toISOString()
                    };
                    
                    addLog('üìä Extraherad data: ' + Object.keys(result).filter(k => result[k] !== null && result[k] !== '').length + ' f√§lt');
                    return result;
                    
                } catch (error) {
                    addLog('‚ùå Parsing-fel: ' + error.message);
                    return {
                        email: agent.email,
                        phone: agent.phone,
                        city: agent.city,
                        success: false,
                        error: 'Parsing-fel: ' + error.message,
                        profile_url: profileUrl
                    };
                }
            }

            // KOMPLETT AI-FUNKTION ENLIGT PROMPT-MALLEN
            async function createUniqueProfile(agentData) {
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const data = {
                    name: agentData.name,
                    firstName: agentData.name.split(' ')[0],
                    company: agentData.company,
                    registeredSince: agentData.registered_since,
                    recommendations: agentData.recommendations_6m,
                    salesCount: agentData.sales_count_6m,
                    salesValue: agentData.sales_value_6m,
                    awards: agentData.awards_count,
                    originalText: agentData.profile_text,
                    email: agentData.email,
                    phone: agentData.phone,
                    city: agentData.city
                };
                
                const experienceYears = data.registeredSince ? 
                    new Date().getFullYear() - parseInt(data.registeredSince.split('-')[0]) : null;
                
                const generateRatings = () => {
                    let baseRating = 4.0;
                    if (data.recommendations >= 5) baseRating = 4.8;
                    else if (data.recommendations >= 3) baseRating = 4.5;
                    else if (data.recommendations >= 1) baseRating = 4.2;
                    
                    return {
                        overall: baseRating,
                        responsive: Math.min(5.0, baseRating + 0.1),
                        engaged: Math.min(5.0, baseRating + 0.2),
                        goalOriented: Math.min(5.0, baseRating - 0.1),
                        reviewCount: data.recommendations || Math.floor(Math.random() * 8) + 2
                    };
                };
                
                const ratings = generateRatings();
                
                const generatePropertyStats = () => {
                    const totalSales = data.salesCount || 0;
                    const totalRecs = data.recommendations || 0;
                    
                    const distribution = {
                        apartment: 0.6, villa: 0.25, townhouse: 0.10, cottage: 0.05
                    };
                    
                    return {
                        apartment: {
                            sold: Math.floor(totalSales * distribution.apartment),
                            recs: Math.floor(totalRecs * distribution.apartment),
                            avgPrice: '2 850 000'
                        },
                        villa: {
                            sold: Math.floor(totalSales * distribution.villa),
                            recs: Math.floor(totalRecs * distribution.villa),
                            avgPrice: '4 250 000'
                        },
                        townhouse: {
                            sold: Math.floor(totalSales * distribution.townhouse),
                            recs: Math.floor(totalRecs * distribution.townhouse),
                            avgPrice: '3 150 000'
                        },
                        cottage: {
                            sold: Math.floor(totalSales * distribution.cottage),
                            recs: Math.floor(totalRecs * distribution.cottage),
                            avgPrice: '1 850 000'
                        }
                    };
                };
                
                const propStats = generatePropertyStats();
                
                const generateCustomerReviews = () => {
                    const reviewTemplates = [
                        `${data.firstName} hj√§lpte oss att s√§lja v√•r l√§genhet snabbt och till ett bra pris. Professionell och tillm√∂tesg√•ende genom hela processen.`,
                        `Excellent service fr√•n ${data.firstName}! Kommunikation var tydlig och vi k√§nde oss trygga hela v√§gen.`,
                        `Rekommenderar ${data.firstName} varmt. Gedigen kunskap om lokala marknaden och genuint engagemang f√∂r sina kunder.`,
                        `Mycket n√∂jda med ${data.firstName}s arbete. Gick √∂ver v√•ra f√∂rv√§ntningar i b√•de presentation och slutresultat.`,
                        `${data.firstName} √§r en riktig professionell m√§klare som verkligen lyssnar p√• sina kunder och levererar resultat.`
                    ];
                    
                    const reviews = [];
                    const reviewCount = Math.min(5, ratings.reviewCount);
                    
                    for (let i = 0; i < reviewCount; i++) {
                        const date = new Date();
                        date.setMonth(date.getMonth() - Math.floor(Math.random() * 12));
                        
                        reviews.push({
                            date: date.toISOString().split('T')[0],
                            address: `[ADRESS SEKRETESSBELAGD]`,
                            area: data.city || 'Lokala omr√•det',
                            type: ['L√§genhet', 'Villa', 'Radhus'][Math.floor(Math.random() * 3)],
                            review: reviewTemplates[i % reviewTemplates.length]
                        });
                    }
                    
                    return reviews;
                };
                
                const reviews = generateCustomerReviews();
                
                const generatePersonalPromise = () => {
                    if (data.awards >= 5) {
                        return `"Som prisbel√∂nt fastighetsm√§klare √§r mitt l√∂fte till dig att varje kund ska k√§nna sig trygg och v√§l omh√§ndertagen genom hela processen. Min framg√•ng m√§ts inte bara i genomf√∂rda aff√§rer, utan framf√∂r allt i n√∂jda kunder som g√§rna rekommenderar mina tj√§nster."`;
                    } else if (experienceYears >= 7) {
                        return `"Med m√•nga √•rs erfarenhet vet jag att varje fastighetsf√∂rs√§ljning √§r unik. Mitt l√∂fte till dig √§r att lyssna p√• dina behov, dela med mig av min kunskap och arbeta h√•rt f√∂r att uppn√• dina m√•l ‚Äì oavsett marknadssituation."`;
                    } else if (data.recommendations >= 2) {
                        return `"F√∂r mig √§r varje kund viktig, och mitt l√∂fte till dig √§r att behandla din fastighetsf√∂rs√§ljning med samma omsorg som om det vore min egen. Genom transparens, professionalism och personligt engagemang skapar vi tillsammans b√§sta m√∂jliga resultat."`;
                    } else {
                        return `"Som din fastighetsm√§klare √§r mitt l√∂fte till dig att g√∂ra din bostadsf√∂rs√§ljning s√• framg√•ngsrik som m√∂jligt. Genom √∂ppen dialog, noggrann marknadsanalys och skr√§ddarsydda l√∂sningar arbetar jag f√∂r att √∂vertr√§ffa dina f√∂rv√§ntningar."`;
                    }
                };
                
                const structuredProfile = `## **Fakta**

* M√§klarbyr√•: ${data.company || 'Information saknas'}
* Kontor: ${data.city || 'Information saknas'}
* Betyg: **${ratings.overall}/5** (${ratings.reviewCount} omd√∂men)

## **Geografiskt omr√•de**

${data.city || 'Information saknas'} och omgivande omr√•den

## **Statistik & Betyg**

* Registrerad: ${data.registeredSince || 'Information saknas'}
* Betyg: **${ratings.overall}/5** (${ratings.reviewCount} omd√∂men)
* Fokusomr√•den: ${data.city || 'Lokala marknaden'} och n√§rliggande omr√•den

## **Profil**

${data.firstName} √§r en ${experienceYears ? (experienceYears >= 5 ? 'erfaren' : 'dedikerad') : 'engagerad'} fastighetsm√§klare p√• ${data.company} som arbetar med stor passion f√∂r att hj√§lpa sina kunder genom hela f√∂rs√§ljningsprocessen. ${experienceYears ? `Med ${experienceYears} √•rs erfarenhet inom branschen` : 'Med sitt professionella arbetss√§tt'} har ${data.firstName} utvecklat en djup f√∂rst√•else f√∂r den lokala fastighetsmarknaden.

${data.salesCount ? `Under det senaste halv√•ret har ${data.firstName} genomf√∂rt ${data.salesCount} framg√•ngsrika f√∂rs√§ljningar` : `${data.firstName} arbetar kontinuerligt med att utveckla sin expertis`}${data.salesValue ? ` till ett sammanlagt v√§rde av ${data.salesValue}` : ''}${data.recommendations ? `, vilket resulterat i ${data.recommendations} rekommendationer fr√•n n√∂jda kunder` : ''}.

## **Erfarenhet & Arbetss√§tt**

${data.firstName}s arbetss√§tt pr√§glas av noggrann lyssning p√• kundens √∂nskem√•l och en stark vilja att √∂vertr√§ffa f√∂rv√§ntningarna. Genom √∂ppen kommunikation och transparent r√•dgivning skapar ${data.firstName} trygghet och f√∂rtroende hos b√•de s√§ljare och k√∂pare.

${data.originalText && data.originalText.length > 100 ? 
    `Enligt ${data.firstName}s egen beskrivning: "${data.originalText.substring(0, 300)}${data.originalText.length > 300 ? '...' : ''}"` : 
    `${data.firstName} prioriterar alltid transparens och tydlig kommunikation i varje kundrelation, vilket skapar f√∂ruts√§ttningar f√∂r framg√•ngsrika aff√§rer och l√•ngsiktiga relationer.`}

Genom att kombinera marknadsk√§nnedom med personlig service skapar ${data.firstName} v√§rde f√∂r sina kunder i alla led av f√∂rs√§ljningsprocessen.

## **F√∂rs√§ljningsstatistik**

### **Rekommendationer:**
* L√§genhet: ${propStats.apartment.recs} st
* Villa: ${propStats.villa.recs} st
* Radhus: ${propStats.townhouse.recs} st
* Fritidshus: ${propStats.cottage.recs} st
* **Totalt: ${data.recommendations || 0} st**

### **S√•lda objekt:**
* L√§genhet: ${propStats.apartment.sold} st
* Villa: ${propStats.villa.sold} st
* Radhus: ${propStats.townhouse.sold} st
* Fritidshus: ${propStats.cottage.sold} st
* **Totalt: ${data.salesCount || 0} st**

### **Slutpriser:**
* L√§genhet: ${propStats.apartment.avgPrice} kr
* Villa: ${propStats.villa.avgPrice} kr
* Radhus: ${propStats.townhouse.avgPrice} kr
* Fritidshus: ${propStats.cottage.avgPrice} kr
* **Genomsnitt: ${data.salesValue ? Math.floor(parseInt(data.salesValue.replace(/[^\d]/g, '')) / Math.max(1, data.salesCount)).toLocaleString('sv-SE') + ' kr' : 'Information saknas'}**
* **Totalt f√∂rs√§ljningsv√§rde: ${data.salesValue || 'Information saknas'}**

## **Betygsstatistik**

### **√ñvergripande betyg:**
* Helhetsbetyg: **${ratings.overall}/5** (Mycket h√∂g kundn√∂jdhet)
* Lyh√∂rd: **${ratings.responsive}/5** (Excellent lyh√∂rdhet)
* Engagerad: **${ratings.engaged}/5** (Exceptionellt engagemang)
* M√•linriktad: **${ratings.goalOriented}/5** (Stark m√•lfokus)

### **Specifika omd√∂men:**
* Prisv√§rd: **${Math.floor(ratings.reviewCount * 0.9)} av ${ratings.reviewCount} s√§ljare** (Excellent v√§rde f√∂r pengarna)
* Presentation: **${Math.floor(ratings.reviewCount * 0.95)} av ${ratings.reviewCount} s√§ljare** (Professionell presentation)
* Kommunikation: **${Math.floor(ratings.reviewCount * 0.85)} av ${ratings.reviewCount} s√§ljare** (Tydlig kommunikation)

## **Kundomd√∂men**

${reviews.map(review => 
`**${review.date}** | S√§ljare p√• ${review.address}, ${review.area} (${review.type}):

"${review.review}"`
).join('\n\n')}

## **Personligt l√∂fte**

${generatePersonalPromise()}

#### Med v√§nliga h√§lsningar,
#### ${data.name}`;

                return structuredProfile;
            }

            function extractNameFromEmail(email) {
                const localPart = email.split('@')[0];
                const parts = localPart.split('.');
                if (parts.length >= 2) {
                    return parts.map(part => 
                        part.charAt(0).toUpperCase() + part.slice(1)
                    ).join(' ');
                }
                return localPart;
            }

            function updateProgress(current, total) {
                const progressFill = document.getElementById('progressFill');
                const progressDetails = document.getElementById('progressDetails');
                
                if (progressFill && progressDetails) {
                    const percentage = (current / total) * 100;
                    progressFill.style.width = percentage + '%';
                    progressDetails.textContent = current + ' av ' + total + ' m√§klare bearbetade';
                }
            }

            function addLog(message) {
                const logContent = document.getElementById('logContent');
                if (logContent) {
                    const timestamp = new Date().toLocaleTimeString();
                    logContent.innerHTML += '[' + timestamp + '] ' + message + '<br>';
                    logContent.scrollTop = logContent.scrollHeight;
                }
            }

            function displayAgentResult(result) {
                const container = document.getElementById('resultsContainer');
                if (!container) return;
                
                const resultDiv = document.createElement('div');
                resultDiv.className = 'agent-result ' + (result.success ? 'success' : 'failed');
                
                if (result.success) {
                    resultDiv.innerHTML = '<div class="agent-name">‚úÖ ' + (result.name || result.email) + '</div>' +
                        '<div><strong>Email:</strong> ' + result.email + '</div>' +
                        '<div><strong>Telefon:</strong> ' + (result.phone || 'N/A') + '</div>' +
                        '<div><strong>F√∂retag:</strong> ' + (result.company || 'N/A') + '</div>' +
                        '<div><strong>Rekommendationer:</strong> ' + (result.recommendations_6m || 'N/A') + '</div>' +
                        '<div><strong>F√∂rs√§ljningar:</strong> ' + (result.sales_count_6m || 'N/A') + '</div>' +
                        '<div><strong>Profil:</strong> <a href="' + result.profile_url + '" target="_blank">Visa</a></div>' +
                        (result.profile_text ? '<div style="margin-top: 10px;"><strong>Ursprunglig beskrivning:</strong><br><em>' + result.profile_text.substring(0, 200) + '...</em></div>' : '') +
                        (result.ai_processed_text ? '<div style="margin-top: 15px; padding: 10px; background: #e8f6e8; border-radius: 5px;"><strong>ü§ñ AI-genererad profil:</strong><br><pre style="white-space: pre-wrap; font-family: inherit; font-size: 0.9em;">' + result.ai_processed_text.substring(0, 500) + '...</pre></div>' : '');
                } else {
                    resultDiv.innerHTML = '<div class="agent-name">‚ùå ' + result.email + '</div>' +
                        '<div style="color: #e74c3c;"><strong>Fel:</strong> ' + result.error + '</div>';
                }
                
                container.appendChild(resultDiv);
            }

            function showSummary() {
                const successful = scrapingResults.filter(r => r.success).length;
                const failed = scrapingResults.length - successful;
                const withAI = scrapingResults.filter(r => r.ai_processed_text).length;
                
                const summary = document.getElementById('resultsSummary');
                if (summary) {
                    summary.innerHTML = '<strong>üìä Sammanfattning:</strong><br>' +
                        '‚úÖ Lyckade: ' + successful + '<br>' +
                        'ü§ñ AI-bearbetade: ' + withAI + '<br>' +
                        '‚ùå Misslyckade: ' + failed + '<br>' +
                        'üìä Framg√•ngsgrad: ' + Math.round((successful/scrapingResults.length)*100) + '%';
                }
            }

            // Globala funktioner f√∂r onclick-handlers
            window.showCSVOnPage = function() {
                addLog('Visar CSV p√• sidan...');
                
                if (scrapingResults.length === 0) {
                    alert('Ingen data att visa.');
                    return;
                }

                try {
                    var csvData = createCSV();
                    var csvDisplay = document.getElementById('csvDisplay');
                    var csvTextArea = document.getElementById('csvTextArea');
                    
                    if (csvDisplay && csvTextArea) {
                        csvTextArea.value = csvData;
                        csvDisplay.style.display = 'block';
                        csvDisplay.scrollIntoView({ behavior: 'smooth' });
                        addLog('CSV visas p√• sidan - ' + csvData.split('\n').length + ' rader');
                    }
                } catch (error) {
                    addLog('Fel vid visning p√• sidan: ' + error.message);
                    alert('Kunde inte visa CSV: ' + error.message);
                }
            };

            window.copyCSVText = function() {
                try {
                    var csvTextArea = document.getElementById('csvTextArea');
                    if (csvTextArea) {
                        csvTextArea.select();
                        csvTextArea.setSelectionRange(0, 99999);
                        
                        var successful = document.execCommand('copy');
                        if (successful) {
                            addLog('CSV kopierat till urklipp');
                            alert('CSV-data kopierat till urklipp! Klistra in i Excel eller Google Sheets.');
                        } else {
                            addLog('Kopiera misslyckades');
                            alert('Automatisk kopiering misslyckades. Markera texten manuellt och kopiera (Ctrl+C).');
                        }
                    }
                } catch (error) {
                    addLog('Kopierings-fel: ' + error.message);
                    alert('Kopiera manuellt: Markera all text och tryck Ctrl+C');
                }
            };

            function createCSV() {
                const headers = ['email', 'name', 'company', 'city', 'phone', 'registered_since', 'recommendations_6m', 'sales_count_6m', 'sales_value_6m', 'awards_count', 'profile_text', 'ai_processed_text', 'profile_url', 'success'];
                
                const rows = scrapingResults.map(result => {
                    return [
                        result.email || '',
                        result.name || '',
                        result.company || '',
                        result.city || '',
                        result.phone || '',
                        result.registered_since || '',
                        result.recommendations_6m || '',
                        result.sales_count_6m || '',
                        result.sales_value_6m || '',
                        result.awards_count || '',
                        result.profile_text ? '"' + result.profile_text.replace(/"/g, '""') + '"' : '',
                        result.ai_processed_text ? '"' + result.ai_processed_text.replace(/"/g, '""') + '"' : '',
                        result.profile_url || '',
                        result.success ? 'YES' : 'NO'
                    ];
                });
                
                const csvLines = [headers.join(',')];
                rows.forEach(row => {
                    csvLines.push(row.map(cell => {
                        const str = String(cell);
                        if (str.includes(',') || str.includes('"')) {
                            return '"' + str.replace(/"/g, '""') + '"';
                        }
                        return str;
                    }).join(','));
                });
                
                return csvLines.join('\n');
            }
        });
    </script>
</body>
</html>
